#!/usr/bin/env python

# drop the lustre lstat table, recreate it
# then copy in the data from the files generated by mpistat
# needs to be run after all the data collection and tidying for all volumes
# has been completed

from __future__ import print_function

import os
import os.path
import psycopg2
import sys
import datetime
import gzip
import subprocess
import traceback

# load in the config
import mpistat_config

# get the date string associated with the datafiles
# the datafiles are of the form YYYYMMDD_VOL#.dat.gz
# e.g. 20150107_113.dat.gz
def get_date_string() :
    return datetime.datetime.now().strftime('%Y%m%d')

# main program
if __name__ == "__main__":
    try :

        # get a db connection
        db_conn = psycopg2.connect("dbname='%s' user='%s' host='%s' password='%s'" % (mpistat_config.DB_NAME, mpistat_config.DB_USER, mpistat_config.DB_HOST, mpistat_config.DB_PASSWD))
        db_conn.autocommit=True;
        db_cur = db_conn.cursor()

        # drop the table
        db_cur.execute("drop table if exists tlstat")

        # create the table without indices
        table_sql='''
            create table tlstat (
                lstat_id serial primary key,
                vol int not null,
                path text not null,
                size bigint not null,
                uid bigint not null,
                gid bigint not null,
                atime bigint not null,
                mtime bigint not null,
                ctime bigint not null,
                type char not null,
                inode bigint not null,
                hardlinks int not null,
                device bigint not null
            )
        '''
        db_cur.execute(table_sql)

        # add indices
        db_cur.execute("create index on tlstat(vol)")
        db_cur.execute("create index on tlstat(uid)")
        db_cur.execute("create index on tlstat(gid)")
        db_cur.execute("create index on tlstat(uid,gid)")
        db_cur.execute("create index on tlstat(size)")
        db_cur.execute("create index on tlstat(atime)")
        db_cur.execute("create index on tlstat(mtime)")
        db_cur.execute("create index on tlstat(ctime)")

        # copy in the data for each lustre volume
        date_str=get_date_string()
        for vol in mpistat_config.VOLUMES :
            fname=mpistat_config.DATA_DIR+'/'+date_str+'_'+str(vol)+'.dat'
            db_cur.copy_from(open(fname),'tlstat',columns=('vol','path','size','uid','gid','atime','mtime','ctime','type','inode','hardlinks','device'),size=1048576)
            # gzip the data file
            subprocess.check_call(['gzip', fname])

        # clean up
        db_cur.close()
        db_conn.close()

    except Exception as e:
        print(str(e), file=sys.stderr)
        traceback.format_exc()  
        sys.exit(1)

